<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="Dropdown.css">
    <link rel="stylesheet" type="text/css" href="demonstration.css">
    <script type="text/javascript" src="Dropdown.js"></script>
</head>
<body>
    <ul class="dropdown">
        <li class="">
            <span>Menu</span>
            <ul>
                <li >
                    <span>IMDb</span>
                    <ul>
                        <li class="">
                            <span>Puntaje de IMDb</span>
                        </li>
                        <li class="">
                            <span>Premios</span>
                        </li>
                        <li class="">
                            <span>Ficha Director</span>
                        </li>
                    </ul>
                </li>
                <li class="">
                    <span>Mercado Libre</span>
                </li>
            </ul>
        </li>
    </ul>

    <ul>
        <li class="peli" id="1111">
            <span>Peli-1</span>
            <p class="id">1</p>
        </li>
        <li class="peli">
            <span>Peli-2</span>
            <p class="id">2</p>
        </li>
    </ul>
</body>
<script type="text/javascript">

    aFunction = function(msg, htmlNode){
        //alert(msg);
        var a = document.createElement("a");
        a.href = "www.google.com";
        a.appendChild(document.createTextNode("Soy un link"));
        htmlNode.style.color = "blue";
        htmlNode.appendChild(a);
    };

    GuiManager = {
        drawSubmenuItem: function(item, htmlNode){
            var listItem = document.createElement("li");

            var span = document.createElement("span");
            listItem.appendChild(span);
            span.appendChild(document.createTextNode(item.description));
            span.onclick = function(){item.method(item.description, htmlNode)};

            return listItem;
        },

        drawSubmenu: function(decorator, htmlNode){
            var subMenuItem = document.createElement("li");

            var span = document.createElement("span");
            subMenuItem.appendChild(span);
            span.appendChild(document.createTextNode(decorator.name));

            var listaMetodosDecoradores = document.createElement("ul");
            subMenuItem.appendChild(listaMetodosDecoradores);

            for (aFunction of decorator.functions){
                // aFunction.drawSubmenuItem(aFunction, htmlNode);
                var nodoFuncion = this.drawSubmenuItem(aFunction, htmlNode);
                listaMetodosDecoradores.appendChild(nodoFuncion);
            }

            return subMenuItem;
        },

        drawMenu: function(htmlNode, decoratorList){
            var contenedorUlMenu = document.createElement("ul");
            contenedorUlMenu.className = "dropdown";

            var contenedorLiMenu = document.createElement("li");
            contenedorUlMenu.appendChild(contenedorLiMenu);

            var spanMenu = document.createElement("span");
            contenedorLiMenu.appendChild(spanMenu);
            spanMenu.appendChild(document.createTextNode("Menu"));

            var listaDecoradores = document.createElement("ul");
            contenedorLiMenu.appendChild(listaDecoradores);

            for (decorator of decoratorList){
                // decorator.drawSubmenu(decorator, htmlNode);
                var submenu = this.drawSubmenu(decorator, htmlNode);
                listaDecoradores.appendChild(submenu);
            }

            htmlNode.appendChild(contenedorUlMenu);
        }
    }

    webserviceData = [
        {
            "name": "Cartelera de Cinema La Plata",
            "urlPattern": "http://cinemalaplata.com/cartelera.aspx",
            "concepts": [
                {
                    "id": 1440162653658,
                    "name": "Movie",
                    "tags": ["movie"],
                    "xpath": "//div[@class=\"page-container singlepost\"]",
                    "properties": [
                        {
                            "id": 1440000442392,
                            "name": "Title",
                            "tags": ["title"],
                            "xpath": ".//h4[@class=\"shortcodes-title\""
                        }
                    ]
                }
            ]
        },
        {
            "name": "Sitio de prueba",
            "urlPattern": "file:///D:/oo2/CinemaLaPlata_Decorator/TestMenus.html",
            "concepts": [
                {
                    "id": 432432432,
                    "name": "Pelicula",
                    "tags": ["movie", "Peli"],
                    "xpath": "//li[@class=\"peli\"]",
                    "properties": [
                        {
                            "id": 43432,
                            "name": "Title",
                            "tags": ["title"],
                            "xpath": "//p[@class=\"id\"]"
                        }
                    ]
                }
            ]
        },
    ];

    WebService = {
        /*
          FakeService
        */    
        concepts: function () {
            elements = [{},{}];
            return webserviceData;
        }
    };
    
    DecoratorRepository = {
        decorators: [{
        type: "Pelicula",
        elements: [
            {
                name: "IMDB",
                functions: [
                    {
                        description: "Puntaje de IMDb" ,
                        method : aFunction
                    },
                    {
                        description: "Premios",
                        method : aFunction
                    },
                    {
                        description: "Ficha de Director",
                        method : aFunction
                    }
                ]
            },
            {
                name: "Mercado Libre",
                functions: [
                    {
                        description: "Buscar Precios",
                        method : aFunction
                    }
                ]
            }
        ]
        },
        {
            type: "song",
            elements: [
            ]
        }],
        getDecoratorsByConcept: function (aConcept) {
            for (var i = this.decorators.length - 1; i >= 0; i--) {
                if (this.decorators[i].type == aConcept.name) {
                    return this.decorators[i].elements;
                }
            };   
        }
    }

    XpathHelper = {
        getSnapshot: function(xpath){
            return document.evaluate(xpath, document, null, XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null);
        }
    }

    function Concept (aJson) {
        this.id    = aJson.id;
        this.name  = aJson.name;
        this.tags  = aJson.tags;
        this.xpath = aJson.xpath;
        this.properties = aJson.properties;

        this.getNodes = function (){
            var htmlObjects = XpathHelper.getSnapshot(this.xpath);
            var htmlNodes = [];

            for (var i = htmlObjects.snapshotLength - 1; i >= 0; i--) {
                htmlObjects.snapshotItem(i).conceptProperties = this.properties;
                htmlNodes.push(htmlObjects.snapshotItem(i));
            };

            return htmlNodes;
        }

        this.createMenu = function () {
            var decorators = DecoratorRepository.getDecoratorsByConcept(this);

            for (node of this.getNodes()){
                GuiManager.drawMenu(node, decorators);
            }

            console.log(this.htmlNodes);
        }
    }

    function WebsiteConceptCollection(aJson){
        this.name = aJson.name;
        this.urlPattern = aJson.urlPattern;
        this.concepts = aJson.concepts.map(function(item){return new Concept(item)});

        this.createMenu = function () {
            for (var i = this.concepts.length - 1; i >= 0; i--) {
                this.concepts[i].createMenu();
            };
        };
    }

    function CCFactory(){
        this.jsonList = [];
        this.siteUrl = null;

        this.matchWithLocation = function (url) {
            //retorna si la url coincide o aplica para la ubicacion(location.hostname)
            return url == this.siteUrl;
        };

        this.getJsonConcepts = function () {
            this.jsonList = WebService.concepts();
        };

        this.initialize = function () {
            this.siteUrl = window.location.href;
            this.getJsonConcepts();
            wccList = [];

            for (aJson of this.jsonList) {
                if (this.matchWithLocation(aJson.urlPattern)) {
                    wccList.push(new WebsiteConceptCollection(aJson));
                };
            };

            return wccList;
        };
    };

    DecoratorManager = {
        create: function (WCCList){
            for (aWCC of WCCList) {
                aWCC.createMenu();
            };
        }
    }
    
    var aCCFactory = new CCFactory();
    wccList = aCCFactory.initialize();

    DecoratorManager.create(wccList);




    // initialise the drop-down menus
    Dropdown.initialise();
</script>
</html>